class h{constructor(){this.allowedNames=["GUSTAVO SANTOS RIBEIRO","GUSTAVO S RIBEIRO"],this.minAmount=10,this.dbName="pixValidationDB",this.storeName="transactions",this.cleanupDays=60,this.db=null,this.init()}async init(){if(!window.indexedDB){console.warn("IndexedDB n√£o suportado");return}return new Promise((t,e)=>{const a=indexedDB.open(this.dbName,1);a.onerror=()=>e(a.error),a.onsuccess=n=>{this.db=n.target.result,this.autoCleanup(),t()},a.onupgradeneeded=n=>{const r=n.target.result;if(!r.objectStoreNames.contains(this.storeName)){const s=r.createObjectStore(this.storeName,{keyPath:"transactionId"});s.createIndex("date","date",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1})}}}).catch(t=>{console.error("Erro ao inicializar banco de dados:",t)})}normalizeName(t){return t?t.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim():""}isValidName(t){const e=this.normalizeName(t);return this.allowedNames.map(n=>this.normalizeName(n)).includes(e)}isValidAmount(t){const e=parseFloat(t);return!isNaN(e)&&e>=this.minAmount}isValidDate(t){const a=new Date().toISOString().split("T")[0],r=new Date(t).toISOString().split("T")[0];return a===r}async checkTransactionExists(t){return this.db||await this.init(),new Promise((e,a)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);s.onsuccess=()=>{e(!!s.result)},s.onerror=()=>e(!1)})}async saveTransaction(t){return this.db||await this.init(),new Promise((e,a)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),s={transactionId:t.transactionId,beneficiary:t.beneficiary,amount:t.amount,date:t.date,timestamp:Date.now()},c=r.add(s);c.onsuccess=()=>e(!0),c.onerror=i=>{i.target.error.name==="ConstraintError"?e(!1):a(i.target.error)}})}async validateReceipt(t){const{beneficiary:e,amount:a,date:n,transactionId:r}=t,s=this.isValidName(e),c=this.isValidAmount(a),i=this.isValidDate(n),d=await this.checkTransactionExists(r);return console.log("Valida√ß√£o:",{nameOk:s,amountOk:c,dateOk:i,transactionExists:d}),s&&c&&i&&d?{status:"RECUSADO",message:"Por favor fa√ßa um novo pagamento",details:"ID de transa√ß√£o j√° cadastrado anteriormente"}:!s&&c&&i?{status:"RECUSADO",message:"Por favor fa√ßa um novo pagamento",details:"Nome do favorecido n√£o corresponde"}:s&&!c&&i?{status:"RECUSADO",message:"Por favor fa√ßa um novo pagamento",details:"Valor m√≠nimo n√£o atingido"}:s&&c&&!i?{status:"RECUSADO",message:"Por favor fa√ßa um novo pagamento",details:"Data da transa√ß√£o n√£o √© a data atual"}:s&&c&&i&&!d?(await this.saveTransaction(t),{status:"APROVADO",message:"Comprovante validado com sucesso",details:"Consulta liberada"}):{status:"RECUSADO",message:"Por favor fa√ßa um novo pagamento",details:"Valida√ß√£o n√£o atendida"}}async autoCleanup(){const t=localStorage.getItem("lastPixCleanup"),e=new Date().toDateString();if(t!==e)try{this.db||await this.init();const a=new Date;a.setDate(a.getDate()-this.cleanupDays);const n=a.getTime(),c=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).openCursor();let i=0;c.onsuccess=d=>{const u=d.target.result;u?(u.value.timestamp<n&&(u.delete(),i++),u.continue()):(i>0&&console.log("Limpeza autom√°tica: "+i+" transa√ß√µes antigas removidas"),localStorage.setItem("lastPixCleanup",e))},c.onerror=()=>{console.warn("Erro durante limpeza autom√°tica")}}catch(a){console.error("Erro na limpeza autom√°tica:",a)}}async getAllTransactions(){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();r.onsuccess=()=>t(r.result||[]),r.onerror=()=>t([])})}}const l=new h;async function m(o){console.log("üîç Validando PIX:",o);try{const t=await l.validateReceipt({beneficiary:o.beneficiary||o.nomeFavorecido,amount:o.amount||o.valor,date:o.date||o.data,transactionId:o.transactionId||o.idTransacao});return{success:t.status==="APROVADO",approved:t.status==="APROVADO",status:t.status,message:t.message,details:t.details}}catch(t){return{success:!1,approved:!1,status:"ERRO",message:"Erro na valida√ß√£o",details:t.message}}}async function f(o){try{const t=await l.checkTransactionExists(o);return{exists:t,message:t?"Duplicada":"Nova"}}catch(t){return{exists:!1,message:t.message}}}async function g(){try{return localStorage.removeItem("lastPixCleanup"),{success:!0,message:"Dados resetados"}}catch(o){return{success:!1,message:o.message}}}const p=m,N={validatePayment:m,checkDuplicateTransaction:f,clearPIXData:g,validatePIX:p};export{f as checkDuplicateTransaction,g as clearPIXData,N as default,p as validatePIX,m as validatePayment};
