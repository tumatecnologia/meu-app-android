import React, { useState, useEffect, useCallback } from 'react';
import { motion } from 'framer-motion';
import { RotateCw, Sparkles, Calendar } from 'lucide-react';
import TarotCardComponent from './TarotCardComponent';
import { 
  getThemeDisplayName,
  getPositionImpact,
  getCardLesson,
  getCardEnergy,
  analyzeCardsSynergy,
  generateSpecificWarnings,
  generateOpportunities,
  generateChallengesAndSolutions,
  generatePracticalActions,
  getExpandedFinalAdvice,
  generateEnergyProtections,
  generateKeywords
} from './tarotHelpers';

const TarotReading = ({ theme, userData, onNewReading }) => {
  const [reading, setReading] = useState(null);
  const [loading, setLoading] = useState(true);

  const themeLabels = {
    'amor': 'Amor',
    'carreira': 'Carreira',
    'financas': 'Finan√ßas',
    'espiritualidade': 'Espiritualidade',
    'saude': 'Sa√∫de',
    'traicao': 'Trai√ß√£o',
    'casamento': 'Casamento',
    'viagem': 'Viagem',
    'noivado': 'Noivado',
    'conselho': 'Conselho',
    'justica': 'Justi√ßa'
  };

  const getFirstName = (fullName) => {
    if (!fullName) return '';
    return fullName.split(' ')[0];
  };

  const formatBirthDate = (dateString) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
  };

  // Mover generateInterpretation para antes de generateReading
  const generateInterpretation = useCallback((theme, cards, userData) => {
    const themeTexts = {
      'amor': `Baseado nas cartas sorteadas, sua jornada amorosa revela insights profundos. `,
      'carreira': `Suas cartas indicam caminhos profissionais e oportunidades. `,
      'financas': `A sabedoria das cartas ilumina sua situa√ß√£o financeira. `,
      'espiritualidade': `Sua conex√£o espiritual √© fortalecida pelas mensagens destas cartas. `,
      'saude': `As cartas trazem reflex√µes sobre seu bem-estar e sa√∫de. `,
      'traicao': `Estas cartas revelam verdades sobre confian√ßa e lealdade. `,
      'casamento': `O destino do seu relacionamento √© revelado pelas cartas. `,
      'viagem': `Sua jornada f√≠sica e espiritual √© iluminada. `,
      'noivado': `O futuro do seu compromisso amoroso √© revelado. `,
      'conselho': `As cartas oferecem orienta√ß√£o s√°bia para sua situa√ß√£o. `,
      'justica': `Equil√≠brio e justi√ßa s√£o os temas centrais desta leitura. `
    };

    let interpretation = themeTexts[theme] || `Suas cartas revelam mensagens importantes sobre sua jornada. `;
    
    interpretation += `\n\n${cards[0].card_name} (Passado${cards[0].reversed ? ' - Invertida' : ''}):\n${cards[0].meaning}\n\n`;
    interpretation += `${cards[1].card_name} (Presente${cards[1].reversed ? ' - Invertida' : ''}):\n${cards[1].meaning}\n\n`;
    interpretation += `${cards[2].card_name} (Futuro${cards[2].reversed ? ' - Invertida' : ''}):\n${cards[2].meaning}\n\n`;
    
    // ============================================
    // CONSELHO FINAL EXPANDIDO E PERSONALIZADO
    // ============================================
    
    const firstName = getFirstName(userData?.name || '');
    const birthDate = formatBirthDate(userData?.birthDate || '');
    const question = userData?.question || '';
    const gender = userData?.gender || '';
    
    interpretation += `\n\nüéØ **CONSELHO FINAL - AN√ÅLISE PROFUNDA**\n\n`;
    
    // ========== CABE√áALHO PERSONALIZADO ==========
    interpretation += `LEITURA PERSONALIZADA\n`;
    if (firstName) {
      interpretation += `**Para:** ${firstName}\n`;
    }
    if (birthDate) {
      interpretation += `**Nascimento:** ${birthDate}\n`;
    }
    if (question) {
      interpretation += `**Pergunta:** "${question}"\n`;
    }
    interpretation += `**Tema:** ${getThemeDisplayName(theme)}\n\n`;
    
    // ========== AN√ÅLISE DETALHADA DAS CARTAS ==========
    interpretation += `AN√ÅLISE DETALHADA DAS CARTAS\n\n`;
    
    cards.forEach((card, index) => {
      const positionNames = ['PASSADO ', 'PRESENTE ', 'FUTURO '];
      
      interpretation += `${index + 1}. **${card.card_name.toUpperCase()}** (${positionNames[index]}) ${card.reversed ? 'üîÅ REVERSA' : 'NORMAL'}\n`;
      interpretation += `   **Significado:** ${card.meaning}\n`;
      interpretation += `   **Impacto:** ${getPositionImpact(card, index)}\n`;
      interpretation += `   **Li√ß√£o:** ${getCardLesson(card, theme)}\n`;
      interpretation += `   **Energia:** ${getCardEnergy(card)}\n\n`;
    });
    
    // ========== SINERGIA ENTRE AS CARTAS ==========
    interpretation += `üîÑ **SINERGIA ENTRE AS CARTAS**\n`;
    interpretation += `${analyzeCardsSynergy(cards)}\n\n`;
    
    // ========== ALERTAS IMPORTANTES ==========
    interpretation += `‚ö†Ô∏è **ALERTAS IMPORTANTES**\n`;
    interpretation += `${generateSpecificWarnings(cards, theme)}\n\n`;
    
    // ========== OPORTUNIDADES ==========
    interpretation += `üí° **OPORTUNIDADES A EXPLORAR**\n`;
    interpretation += `${generateOpportunities(cards, theme)}\n\n`;
    
    // ========== DESAFIOS E SUPERACOES ==========
    interpretation += `üõ°Ô∏è **DESAFIOS E COMO SUPER√Å-LOS**\n`;
    interpretation += `${generateChallengesAndSolutions(cards)}\n\n`;
    
    // ========== A√á√ïES PR√ÅTICAS ==========
    interpretation += `üöÄ **A√á√ïES PR√ÅTICAS PARA OS PR√ìXIMOS 7 DIAS**\n`;
    interpretation += `${generatePracticalActions(cards, firstName)}\n\n`;
    
    // ========== CONSELHO FINAL PERSONALIZADO ==========
    interpretation += ` **CONSELHO FINAL PERSONALIZADO**\n`;
    if (firstName) {
      interpretation += `${firstName}, `;
    }
    interpretation += `${getExpandedFinalAdvice(theme, cards, firstName)}\n\n`;
    
    // ========== PROTE√á√ïES ENERG√âTICAS ==========
    interpretation += `‚ú® **PROTE√á√ïES ENERG√âTICAS RECOMENDADAS**\n`;
    interpretation += `${generateEnergyProtections(cards)}\n\n`;
    
    // ========== PALAVRAS-CHAVE ==========
    interpretation += `üîë **PALAVRAS-CHAVE DA SUA JORNADA**\n`;
    interpretation += `${generateKeywords(cards)}\n\n`;
    
    // ========== MENSAGEM FINAL ==========
    interpretation += `üåü **MENSAGEM FINAL**\n`;
    interpretation += `Que esta leitura seja um farol em seu caminho, ${firstName || 'querid' + (gender === 'F' ? 'a' : 'o')}! `;
    interpretation += `Lembre-se: cada carta √© um cap√≠tulo de sua hist√≥ria, mas voc√™ √© o autor do livro completo.\n\n`;
    
    // ========== DATA E ASSINATURA ==========
    const now = new Date();
    interpretation += `üìÖ **Data da leitura:** ${now.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    })} √†s ${now.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    })}`;